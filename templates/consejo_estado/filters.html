<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consejo de Estado - SAMAI Scraper</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- jQuery UI CSS para datepicker -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .container {
            max-width: 900px;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .filter-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        .btn-search {
            background-color: #3498db;
            color: white;
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .btn-search:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }
        .results-section {
            display: none;
            margin-top: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
        }
        .progress-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .log-viewer {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .error-item {
            background-color: #fee;
            border-left: 4px solid #dc3545;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .section-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header text-center">
            <h1><i class="fas fa-gavel"></i> Consejo de Estado - SAMAI</h1>
            <p class="mb-0">Sistema de búsqueda y descarga de providencias judiciales</p>
        </div>

        <!-- Filtros -->
        <div class="filter-card">
            <h3 class="section-title"><i class="fas fa-filter"></i> Filtros de Búsqueda</h3>

            <form id="searchForm">
                <div class="row">
                    <!-- Sala de Decisión -->
                    <div class="col-md-12 mb-3">
                        <label for="sala_decision" class="form-label">
                            <i class="fas fa-balance-scale"></i> Sala de Decisión
                        </label>
                        <select class="form-select" id="sala_decision" name="sala_decision" required>
                            <option value="">Seleccione una sala...</option>
                            <option value="Plena">Plena</option>
                            <option value="Plena de lo Contencioso Administrativo">Plena de lo Contencioso Administrativo</option>
                            <option value="Sala de Consulta y Servicio Civil">Sala de Consulta y Servicio Civil</option>
                            <option value="Sección Primera">Sección Primera</option>
                            <option value="Sección Segunda">Sección Segunda</option>
                            <option value="Sección Tercera">Sección Tercera</option>
                            <option value="Sección Cuarta" selected>Sección Cuarta</option>
                            <option value="Sección Quinta">Sección Quinta</option>
                        </select>
                    </div>

                    <!-- Fechas -->
                    <div class="col-md-6 mb-3">
                        <label for="fecha_desde" class="form-label">
                            <i class="fas fa-calendar-alt"></i> Fecha Desde
                        </label>
                        <input type="text" class="form-control" id="fecha_desde" name="fecha_desde"
                               placeholder="DD/MM/YYYY" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="fecha_hasta" class="form-label">
                            <i class="fas fa-calendar-alt"></i> Fecha Hasta
                        </label>
                        <input type="text" class="form-control" id="fecha_hasta" name="fecha_hasta"
                               placeholder="DD/MM/YYYY" required>
                    </div>

                    <!-- Configuración fija por ahora -->
                    <input type="hidden" id="download_pdfs" name="download_pdfs" value="true">
                    <input type="hidden" id="max_results" name="max_results" value="">
                    <input type="hidden" id="max_workers" name="max_workers" value="1">
                </div>

                <!-- Botones -->
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-secondary me-2" id="previewBtn">
                        <i class="fas fa-eye"></i> Vista Previa (5 resultados)
                    </button>
                    <button type="submit" class="btn btn-search">
                        <i class="fas fa-search"></i> Buscar y Procesar
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading -->
        <div class="loading">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Procesando búsqueda...</p>
        </div>

        <!-- Resultados -->
        <div class="results-section">
            <!-- Estadísticas -->
            <div class="row" id="statsContainer">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="totalResults">0</div>
                        <div>Total Resultados</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPages">0</div>
                        <div>Total Páginas</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number text-success" id="successfulDownloads">0</div>
                        <div>Descargas Exitosas</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number text-danger" id="failedDownloads">0</div>
                        <div>Descargas Fallidas</div>
                    </div>
                </div>
            </div>

            <!-- Progreso -->
            <div class="progress-section">
                <h5><i class="fas fa-tasks"></i> Progreso</h5>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" id="progressBar" style="width: 0%">0%</div>
                </div>
                <p class="mt-2 mb-0" id="progressText">Iniciando proceso...</p>
            </div>

            <!-- Botones de acción -->
            <div class="text-center mt-4">
                <button class="btn btn-danger" id="cancelBtn" style="display:none;">
                    <i class="fas fa-stop"></i> Cancelar Proceso
                </button>
                <button class="btn btn-success" id="downloadCsvBtn" style="display:none;">
                    <i class="fas fa-file-csv"></i> Descargar CSV
                </button>
                <button class="btn btn-info" id="viewLogsBtn">
                    <i class="fas fa-file-alt"></i> Ver Logs
                </button>
            </div>

            <!-- Errores -->
            <div class="mt-4" id="errorsSection" style="display:none;">
                <h5><i class="fas fa-exclamation-triangle"></i> Errores de Descarga</h5>
                <div id="errorsList"></div>
            </div>

            <!-- Visor de logs -->
            <div class="log-viewer" id="logViewer" style="display:none;">
                <pre id="logContent">Esperando logs...</pre>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variables globales
        let currentTimestamp = null;
        let updateInterval = null;
        let logUpdateInterval = null;

        // Configurar datepickers
        $(function() {
            $("#fecha_desde, #fecha_hasta").datepicker({
                dateFormat: 'dd/mm/yy',
                changeMonth: true,
                changeYear: true,
                maxDate: 0
            });

            // Establecer fechas por defecto (último mes)
            const hoy = new Date();
            const haceUnMes = new Date();
            haceUnMes.setMonth(hoy.getMonth() - 1);

            $("#fecha_desde").datepicker('setDate', haceUnMes);
            $("#fecha_hasta").datepicker('setDate', hoy);
        });

        // Vista previa
        $('#previewBtn').click(function() {
            const formData = {
                sala_decision: $('#sala_decision').val(),
                fecha_desde: $('#fecha_desde').val(),
                fecha_hasta: $('#fecha_hasta').val()
            };

            if (!validateForm()) {
                return;
            }

            $('.loading').show();
            $('.results-section').hide();

            $.ajax({
                url: '/consejo_estado/preview',
                method: 'POST',
                data: formData,
                success: function(response) {
                    $('.loading').hide();

                    if (response.status === 'success') {
                        // Mostrar información sin alert
                        $('#progressText').text(`Se encontraron documentos. Mostrando primeros 5:`);
                        $('.results-section').show();

                        // Mostrar los documentos en el área de resultados
                        let previewHtml = '<div class="mt-3"><h5>Vista Previa:</h5><ol>';
                        response.preview.forEach((doc, idx) => {
                            previewHtml += `<li>${doc.numero_proceso} - ${doc.titular}</li>`;
                        });
                        previewHtml += '</ol></div>';
                        $('#progressText').after(previewHtml);
                    } else {
                        $('#progressText').text('Error: ' + response.message);
                        $('.results-section').show();
                    }
                },
                error: function(xhr) {
                    $('.loading').hide();
                    $('#progressText').text('Error al obtener vista previa');
                    $('.results-section').show();
                }
            });
        });

        // Formulario principal
        $('#searchForm').submit(function(e) {
            e.preventDefault();

            if (!validateForm()) {
                return;
            }

            const formData = {
                sala_decision: $('#sala_decision').val(),
                fecha_desde: $('#fecha_desde').val(),
                fecha_hasta: $('#fecha_hasta').val(),
                download_pdfs: $('#download_pdfs').is(':checked'),
                max_results: $('#max_results').val() || null,
                max_workers: $('#max_workers').val() || 3
            };

            $('.loading').show();
            $('.results-section').hide();
            $('#cancelBtn').show();
            $('#downloadCsvBtn').hide();

            $.ajax({
                url: '/consejo_estado/start_scraping',
                method: 'POST',
                data: formData,
                success: function(response) {
                    $('.loading').hide();

                    if (response.status === 'started') {
                        currentTimestamp = response.timestamp;
                        $('.results-section').show();
                        startStatusUpdates();

                        // Mostrar info inicial
                        $('#progressText').text(`Proceso iniciado. Buscando en ${formData.sala_decision}...`);
                    } else {
                        $('#progressText').text('Error: ' + response.message);
                        $('.results-section').show();
                    }
                },
                error: function(xhr) {
                    $('.loading').hide();
                    $('#progressText').text('Error al iniciar el proceso');
                    $('.results-section').show();
                }
            });
        });

        // Cancelar proceso
        $('#cancelBtn').click(function() {
            if (!currentTimestamp) return;

            if (confirm('¿Está seguro de cancelar el proceso?')) {
                $.ajax({
                    url: `/consejo_estado/cancel_scraping/${currentTimestamp}`,
                    method: 'POST',
                    success: function(response) {
                        stopStatusUpdates();
                        $('#progressText').text('Proceso cancelado por el usuario');
                        $('#cancelBtn').hide();
                        $('#progressText').text('Proceso cancelado correctamente');
                    }
                });
            }
        });

        // Descargar CSV
        $('#downloadCsvBtn').click(function() {
            if (currentTimestamp) {
                window.location.href = `/consejo_estado/download_csv/${currentTimestamp}`;
            }
        });

        // Ver logs
        $('#viewLogsBtn').click(function() {
            const $logViewer = $('#logViewer');
            if ($logViewer.is(':visible')) {
                $logViewer.hide();
                stopLogUpdates();
            } else {
                $logViewer.show();
                startLogUpdates();
            }
        });

        // Funciones auxiliares
        function validateForm() {
            let valid = true;
            let message = '';

            if (!$('#sala_decision').val()) {
                message = 'Por favor seleccione una sala de decisión';
                valid = false;
            } else if (!$('#fecha_desde').val() || !$('#fecha_hasta').val()) {
                message = 'Por favor seleccione las fechas';
                valid = false;
            }

            if (!valid) {
                $('#progressText').text(message);
                $('.results-section').show();
            }

            return valid;
        }

        function startStatusUpdates() {
            updateStatus(); // Primera actualización inmediata
            updateInterval = setInterval(updateStatus, 2000); // Cada 2 segundos
        }

        function stopStatusUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            stopLogUpdates();
        }

        function startLogUpdates() {
            updateLogs(); // Primera actualización
            logUpdateInterval = setInterval(updateLogs, 3000); // Cada 3 segundos
        }

        function stopLogUpdates() {
            if (logUpdateInterval) {
                clearInterval(logUpdateInterval);
                logUpdateInterval = null;
            }
        }

        function updateStatus() {
            if (!currentTimestamp) return;

            $.ajax({
                url: `/consejo_estado/status/${currentTimestamp}`,
                method: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        updateUI(response);
                    }
                },
                error: function() {
                    console.error('Error obteniendo estado');
                }
            });
        }

        function updateLogs() {
            if (!currentTimestamp) return;

            $.ajax({
                url: `/logs/consejo_estado/${currentTimestamp}/consejo_estado_scraping.log`,
                method: 'GET',
                success: function(data) {
                    const lines = data.split('\n');
                    const lastLines = lines.slice(-50).join('\n');
                    $('#logContent').text(lastLines);

                    // Auto-scroll al final
                    const logViewer = document.getElementById('logViewer');
                    logViewer.scrollTop = logViewer.scrollHeight;
                }
            });
        }

        function updateUI(data) {
            // Actualizar estadísticas del manifiesto
            if (data.manifest) {
                $('#totalResults').text(data.manifest.total_resultados || 0);
                $('#totalPages').text(data.manifest.total_paginas || 0);
            }

            // Actualizar desde el reporte final si existe
            if (data.final_report) {
                const resumen = data.final_report.resumen;

                $('#totalResults').text(resumen.total_documentos || 0);
                $('#successfulDownloads').text(resumen.descargas_exitosas || 0);
                $('#failedDownloads').text(resumen.descargas_fallidas || 0);

                // Calcular progreso
                const total = resumen.total_documentos || 0;
                const procesados = (resumen.descargas_exitosas || 0) + (resumen.descargas_fallidas || 0);
                const porcentaje = total > 0 ? Math.round((procesados / total) * 100) : 0;

                $('#progressBar').css('width', porcentaje + '%').text(porcentaje + '%');

                // Mostrar errores si hay
                if (data.final_report.errores_descarga && data.final_report.errores_descarga.length > 0) {
                    mostrarErrores(data.final_report.errores_descarga);
                }

                // Proceso completado
                $('#progressText').text(`Proceso completado en ${resumen.tiempo_total}`);
                $('#cancelBtn').hide();
                $('#downloadCsvBtn').show();
                stopStatusUpdates();
            }

            // Actualizar desde archivos existentes
            if (data.files) {
                if (data.files.results_csv_exists) {
                    $('#downloadCsvBtn').show();
                }
            }

            // Leer últimas líneas del log para el progreso
            if (data.log_tail && data.log_tail.length > 0) {
                const lastLogLine = data.log_tail[data.log_tail.length - 1];
                if (lastLogLine.includes('PÁGINA')) {
                    const match = lastLogLine.match(/PÁGINA (\d+)\/(\d+)/);
                    if (match) {
                        $('#progressText').text(`Procesando página ${match[1]} de ${match[2]}`);
                    }
                }
            }
        }

        function mostrarErrores(errores) {
            $('#errorsSection').show();
            const $errorsList = $('#errorsList');
            $errorsList.empty();

            errores.forEach(error => {
                $errorsList.append(`
                    <div class="error-item">
                        <strong>Documento ${error.documento}</strong> (Posición ${error.posicion})<br>
                        Error: ${error.error}
                    </div>
                `);
            });
        }

        // Limpiar al cargar la página
        $(document).ready(function() {
            currentTimestamp = null;
            stopStatusUpdates();
        });
    </script>
</body>
</html>